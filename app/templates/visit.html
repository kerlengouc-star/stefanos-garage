{% extends "base.html" %}

{% block content %}
<div class="container py-4" style="max-width: 1100px;">

  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
    <div>
      <h3 class="m-0">Visit #{{ visit.id }}</h3>
      <small class="text-muted">Fill in details, tick checklist items, then click <b>Save</b> at the bottom.</small>
    </div>
    <div class="d-flex gap-2 flex-wrap">
      <a class="btn btn-sm btn-outline-secondary" href="/history">History</a>
      <a class="btn btn-sm btn-outline-secondary" href="/checklist">Checklist</a>
      <a class="btn btn-sm btn-outline-primary" href="/visits/{{ visit.id }}/print" target="_blank">Print</a>
      <a class="btn btn-sm btn-outline-primary" href="/visits/{{ visit.id }}/pdf" target="_blank">PDF</a>
    </div>
  </div>

  <form id="visit-form" method="post" action="/visits/{{ visit.id }}/save_all" class="card shadow-sm mb-3">
    <div class="card-body">

      <div class="row g-2">
        <div class="col-md-3">
          <label class="form-label">Plate</label>
          <input class="form-control" name="plate_number" value="{{ visit.plate_number or '' }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">VIN</label>
          <input class="form-control" name="vin" value="{{ visit.vin or '' }}">
        </div>
        <div class="col-md-6">
          <label class="form-label">Customer Name</label>
          <input class="form-control" name="customer_name" value="{{ visit.customer_name or '' }}">
        </div>

        <div class="col-md-3">
          <label class="form-label">Phone</label>
          <input class="form-control" name="phone" value="{{ visit.phone or '' }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">Email</label>
          <input class="form-control" name="email" value="{{ visit.email or '' }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">Model</label>
          <input class="form-control" name="model" value="{{ visit.model or '' }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">KM</label>
          <input class="form-control" name="km" value="{{ visit.km or '' }}">
        </div>

        <div class="col-md-6">
          <label class="form-label">Customer Complaint</label>
          <textarea class="form-control" name="customer_complaint" rows="2">{{ visit.customer_complaint or '' }}</textarea>
        </div>
        <div class="col-md-6">
          <label class="form-label">General Notes</label>
          <textarea class="form-control" name="notes_general" rows="2">{{ visit.notes_general or '' }}</textarea>
        </div>

        <div class="col-md-3">
          <label class="form-label">Date In</label>
          <input class="form-control" type="date" name="date_in" value="{{ visit.date_in.strftime('%Y-%m-%d') if visit.date_in else '' }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">Time In</label>
          <input class="form-control" type="time" name="time_in" value="{{ visit.date_in.strftime('%H:%M') if visit.date_in else '' }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">Date Out</label>
          <input class="form-control" type="date" name="date_out" value="{{ visit.date_out.strftime('%Y-%m-%d') if visit.date_out else '' }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">Time Out</label>
          <input class="form-control" type="time" name="time_out" value="{{ visit.date_out.strftime('%H:%M') if visit.date_out else '' }}">
        </div>

        <div class="col-12 mt-2">
          <div class="d-flex gap-2 align-items-center flex-wrap">
            <label class="form-label m-0">View mode:</label>
            <select class="form-select form-select-sm" name="mode" style="max-width: 180px;">
              <option value="all" {% if mode == 'all' %}selected{% endif %}>All</option>
              <option value="selected" {% if mode == 'selected' %}selected{% endif %}>Selected only</option>
            </select>
            <span class="text-muted small">Tip: Save keeps your mode.</span>
          </div>
        </div>

      </div>
    </div>

    <div class="card-body pt-0">
      <hr>

      <div class="accordion" id="cats-accordion">

        {% set last_cat = None %}
        {% for ln in lines %}
          {% if ln.category != last_cat %}
            {% if last_cat is not none %}
                </tbody></table></div></div></div>
              </div>
            {% endif %}

            {% set last_cat = ln.category %}
            {% set cat_id = 'cat_' ~ loop.index %}
            <div class="accordion-item">
              <h2 class="accordion-header" id="h_{{ cat_id }}">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#c_{{ cat_id }}">
                  {{ ln.category }}
                </button>
              </h2>
              <div id="c_{{ cat_id }}" class="accordion-collapse collapse" data-bs-parent="#cats-accordion">
                <div class="accordion-body">

                  <div class="table-responsive">
                    <table class="table table-sm align-middle">
                      <thead>
                        <tr>
                          <th style="width:60px;">Pick</th>
                          <th>Item</th>
                          <th style="width:140px;">Result</th>
                          <th>Notes</th>
                          <th style="width:160px;">Parts code</th>
                          <th style="width:90px;">Qty</th>
                          <th style="width:120px;">Exclude</th>
                        </tr>
                      </thead>
                      <tbody>
          {% endif %}

          <tr>
            <td>
              <input class="form-check-input" type="checkbox" name="selected_ids" value="{{ ln.id }}"
                     {% if ln.result and ln.result != 'OK' %}checked{% endif %}>
            </td>
            <td class="fw-semibold">{{ ln.item_name }}</td>
            <td>
              <select class="form-select form-select-sm" name="result_{{ ln.id }}">
                <option value="OK" {% if (ln.result or 'OK') == 'OK' %}selected{% endif %}>OK</option>
                <option value="CHECK" {% if ln.result == 'CHECK' %}selected{% endif %}>CHECK</option>
                <option value="REPAIR" {% if ln.result == 'REPAIR' %}selected{% endif %}>REPAIR</option>
              </select>
            </td>
            <td><input class="form-control form-control-sm" name="notes_{{ ln.id }}" value="{{ ln.notes or '' }}"></td>
            <td><input class="form-control form-control-sm" name="parts_code_{{ ln.id }}" value="{{ ln.parts_code or '' }}"></td>
            <td><input class="form-control form-control-sm" name="parts_qty_{{ ln.id }}" value="{{ ln.parts_qty or 0 }}"></td>
            <td class="text-center">
              <input class="form-check-input" type="checkbox" name="exclude_{{ ln.id }}" {% if ln.exclude_from_print %}checked{% endif %}>
            </td>
          </tr>

        {% endfor %}

        {% if last_cat is not none %}
              </tbody></table></div></div></div>
            </div>
          </div>
        {% endif %}
      </div>

      <hr>

      <div class="d-flex gap-2 justify-content-end flex-wrap">
        <button class="btn btn-primary" type="submit">Save</button>
      </div>

    </div>
  </form>

  <div class="card shadow-sm">
    <div class="card-body">
      <div class="fw-semibold mb-2">Add new checklist item</div>

      <form id="add-item-form" method="post" action="/visits/{{ visit.id }}/add_item" class="d-flex flex-wrap gap-2 w-100">
        <input class="form-control" name="category" placeholder="Category" style="min-width: 220px;" required>
        <input class="form-control" name="name" placeholder="Work / item name" style="min-width: 280px;" required>
        <button id="add-item-btn" class="btn btn-outline-primary" type="submit">Add</button>
      </form>

      <div class="small text-muted mt-2">
        Adds to checklist and immediately appears in this visit.
      </div>
    </div>
  </div>

</div>

<script>
(function(){
  // ensure accordion works on pages without bootstrap js bundle
  // (if base.html already loads bootstrap bundle, this is harmless)
  const hasBootstrap = !!window.bootstrap;
  if (!hasBootstrap) {
    const s = document.createElement('script');
    s.src = "https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js";
    document.head.appendChild(s);
  }

  // Add item without losing form state: do async post, then reload visit page
  const addForm = document.getElementById("add-item-form");
  const addBtn = document.getElementById("add-item-btn");
  if (addForm) {
    addForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      addBtn.disabled = true;
      try{
        const fd = new FormData(addForm);
        const res = await fetch(addForm.action, { method: "POST", body: fd, credentials: "same-origin" });
        if(!res.ok) throw new Error("HTTP " + res.status);
        // reload to show the new line & keep everything saved
        window.location.href = `/visits/{{ visit.id }}?mode=all`;
      }catch(e){
        alert('Add failed: ' + e.message);
      }finally{
        addBtn.disabled = false;
      }
    });
  }
})();
</script>
{% endblock %}
