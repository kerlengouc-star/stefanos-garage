{% extends "base.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <div class="d-flex align-items-center gap-2">
    <a class="btn btn-outline-secondary btn-sm" href="/">← Πίσω</a>
    <div class="fw-semibold">
      Επίσκεψη #{{ visit.id }} {% if visit.job_no %} ({{ visit.job_no }}) {% endif %}
    </div>
    <div class="badge text-bg-light border">
      Mode: {{ mode|upper }}
    </div>
  </div>

  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary btn-sm" href="/visits/{{ visit.id }}?mode=all">Όλα</a>
    <a class="btn btn-outline-secondary btn-sm" href="/visits/{{ visit.id }}?mode=selected">Επιλεγμένα</a>

    <!-- Τα κουμπιά που ζήτησες -->
    <button form="visitForm" class="btn btn-primary btn-sm" type="submit" name="after_save" value="stay">
      Save
    </button>

    <button form="visitForm" class="btn btn-outline-primary btn-sm" type="submit" name="after_save" value="pdf">
      PDF
    </button>

    <a class="btn btn-outline-primary btn-sm" href="/visits/{{ visit.id }}/print" target="_blank">
      Print
    </a>

    <!-- Email: ανοίγει το email app με link στο PDF (χωρίς να χαλάμε SMTP τώρα) -->
    <a class="btn btn-outline-primary btn-sm"
       href="mailto:{{ visit.email or '' }}?subject={{ ('Job ' ~ (visit.job_no or visit.id))|urlencode }}&body={{ ('Καλημέρα,%0D%0A%0D%0AΣας στέλνω το PDF:%0D%0A' ~ (request.base_url|string) ~ 'visits/' ~ visit.id ~ '/pdf%0D%0A%0D%0AΜε εκτίμηση,%0D%0AO&S STEPHANOU LTD')|safe }}">
      Email
    </a>
  </div>
</div>

<form id="visitForm" method="post" action="/visits/{{ visit.id }}/save_all" autocomplete="off">
  <input type="hidden" name="mode" value="{{ mode }}">
  <input type="hidden" name="action" value="">
  <input type="hidden" name="after_save" value="stay">

  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <h6 class="mb-3">Στοιχεία Πελάτη / Οχήματος</h6>

      <div class="row g-2">
        <div class="col-md-3">
          <label class="form-label">Ημ/νία Άφιξης</label>
          <input class="form-control" type="date" name="date_in_date"
                 value="{% if visit.date_in %}{{ visit.date_in.strftime('%Y-%m-%d') }}{% endif %}">
        </div>
        <div class="col-md-3">
          <label class="form-label">Ώρα Άφιξης</label>
          <input class="form-control" type="time" name="date_in_time"
                 value="{% if visit.date_in %}{{ visit.date_in.strftime('%H:%M') }}{% endif %}">
        </div>
        <div class="col-md-3">
          <label class="form-label">Ημ/νία Παράδοσης</label>
          <input class="form-control" type="date" name="date_out_date"
                 value="{% if visit.date_out %}{{ visit.date_out.strftime('%Y-%m-%d') }}{% endif %}">
        </div>
        <div class="col-md-3">
          <label class="form-label">Ώρα Παράδοσης</label>
          <input class="form-control" type="time" name="date_out_time"
                 value="{% if visit.date_out %}{{ visit.date_out.strftime('%H:%M') }}{% endif %}">
        </div>

        <div class="col-md-4">
          <label class="form-label">Όνομα</label>
          <input class="form-control" name="customer_name" value="{{ visit.customer_name or '' }}" autocomplete="off">
        </div>
        <div class="col-md-4">
          <label class="form-label">Τηλέφωνο</label>
          <input class="form-control" name="phone" value="{{ visit.phone or '' }}" autocomplete="off">
        </div>
        <div class="col-md-4">
          <label class="form-label">Email</label>
          <input class="form-control" name="email" value="{{ visit.email or '' }}" autocomplete="off">
        </div>

        <div class="col-md-3">
          <label class="form-label">Πινακίδα</label>
          <input class="form-control" name="plate_number" value="{{ visit.plate_number or '' }}" autocomplete="off">
        </div>
        <div class="col-md-3">
          <label class="form-label">VIN</label>
          <input class="form-control" name="vin" value="{{ visit.vin or '' }}" autocomplete="off">
        </div>
        <div class="col-md-4">
          <label class="form-label">Μοντέλο</label>
          <input class="form-control" name="model" value="{{ visit.model or '' }}" autocomplete="off">
        </div>
        <div class="col-md-2">
          <label class="form-label">KM</label>
          <input class="form-control" name="km" value="{{ visit.km or '' }}" autocomplete="off">
        </div>

        <div class="col-12">
          <label class="form-label">Παράπονο πελάτη</label>
          <textarea class="form-control" rows="2" name="customer_complaint" autocomplete="off">{{ visit.customer_complaint or '' }}</textarea>
        </div>
      </div>
    </div>
  </div>

  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <h6 class="mb-3">Checklist</h6>

      {% set current_cat = None %}
      {% for ln in lines %}
        {% if current_cat != ln.category %}
          {% set current_cat = ln.category %}
          <div class="mt-3 mb-2 fw-semibold">{{ current_cat }}</div>
          <hr class="my-2">
        {% endif %}

        <div class="row g-2 align-items-center mb-2">
          <div class="col-md-3">
            <div class="small text-muted">Εργασία</div>
            <div class="fw-semibold">{{ ln.item_name }}</div>
          </div>

          <div class="col-md-2">
            <div class="small text-muted">Κατάσταση</div>
            <select class="form-select form-select-sm"
                    name="result_{{ ln.id }}"
                    id="result_{{ ln.id }}"
                    autocomplete="off">
              {% set r = (ln.result or 'OK') %}
              <option value="OK" {% if r=='OK' %}selected{% endif %}>OK</option>
              <option value="CHECK" {% if r=='CHECK' %}selected{% endif %}>CHECK</option>
              <option value="REPAIR" {% if r=='REPAIR' %}selected{% endif %}>REPAIR</option>
            </select>
          </div>

          <!-- ✅ IMPORTANT: ΜΟΝΑΔΙΚΑ name+id ανά γραμμή -->
          <div class="col-md-2">
            <div class="small text-muted">Parts Number</div>
            <input class="form-control form-control-sm"
                   name="parts_code_{{ ln.id }}"
                   id="parts_code_{{ ln.id }}"
                   value="{{ ln.parts_code or '' }}"
                   autocomplete="off"
                   placeholder="π.χ. 12345-ABC">
          </div>

          <div class="col-md-1">
            <div class="small text-muted">Qty</div>
            <input class="form-control form-control-sm"
                   type="number"
                   min="0"
                   name="parts_qty_{{ ln.id }}"
                   id="parts_qty_{{ ln.id }}"
                   value="{{ ln.parts_qty or 0 }}"
                   autocomplete="off">
          </div>

          <div class="col-md-3">
            <div class="small text-muted">Σημειώσεις</div>
            <input class="form-control form-control-sm"
                   name="notes_{{ ln.id }}"
                   id="notes_{{ ln.id }}"
                   value="{{ ln.notes or '' }}"
                   autocomplete="off"
                   placeholder="Σημείωση...">
          </div>

          <div class="col-md-1">
            <div class="small text-muted">Εξαίρεση</div>
            <select class="form-select form-select-sm"
                    name="exclude_{{ ln.id }}"
                    id="exclude_{{ ln.id }}"
                    autocomplete="off">
              <option value="0" {% if not ln.exclude_from_print %}selected{% endif %}>NO</option>
              <option value="1" {% if ln.exclude_from_print %}selected{% endif %}>YES</option>
            </select>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>

  <!-- Κάτω μέρος: κρατάμε το + που ήδη δουλεύει -->
  <div class="card shadow-sm mb-3" id="addnew">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center">
        <h6 class="m-0">+ Νέα Κατηγορία/Εργασία</h6>
        <button class="btn btn-success btn-sm" type="submit"
                onclick="document.querySelector('input[name=action]').value='add_line';">
          +
        </button>
      </div>

      <div class="row g-2 mt-2">
        <div class="col-md-5">
          <label class="form-label">Κατηγορία</label>
          <input class="form-control" name="new_category" autocomplete="off" placeholder="π.χ. Φρένα">
        </div>
        <div class="col-md-5">
          <label class="form-label">Εργασία</label>
          <input class="form-control" name="new_item_name" autocomplete="off" placeholder="π.χ. Αλλαγή τακάκια">
        </div>
        <div class="col-md-2">
          <label class="form-label">Μνήμη</label>
          <select class="form-select" name="new_add_to_master">
            <option value="1" selected>ΝΑΙ</option>
            <option value="0">ΟΧΙ</option>
          </select>
        </div>
      </div>

      <div class="text-muted small mt-2">
        Το “+” προσθέτει γραμμή ΚΑΙ (αν βάλεις Μνήμη=ΝΑΙ) την κρατάει μόνιμα στο Checklist.
      </div>
    </div>
  </div>

</form>

{% endblock %}
