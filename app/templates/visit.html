{% extends "base.html" %}
{% block content %}

<div class="container py-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h4 class="m-0">JOB CARD: {{ visit.job_no or visit.id }}</h4>
      <div class="text-muted" style="font-size:13px;">
        Προβολή:
        {% if mode == "all" %}
          <strong>Όλα</strong> |
          <a href="/visits/{{ visit.id }}?mode=selected">Μόνο επιλεγμένα</a>
        {% else %}
          <strong>Μόνο επιλεγμένα</strong> |
          <a href="/visits/{{ visit.id }}?mode=all">Δείξε όλα</a>
        {% endif %}
      </div>
    </div>

    <div class="d-flex gap-2 flex-wrap">
      <a class="btn btn-outline-success btn-sm" href="/backup" target="_blank" rel="noopener">Backup</a>
      <button class="btn btn-outline-primary btn-sm" type="submit" form="jobform" name="after_save" value="pdf">Save + PDF</button>
      <button class="btn btn-outline-dark btn-sm" type="submit" form="jobform" name="after_save" value="print">Save + Print</button>
      <a class="btn btn-outline-danger btn-sm" href="/">Πίσω</a>
    </div>
  </div>

  <form id="jobform" method="post" action="/visits/{{ visit.id }}/save_all" class="card shadow-sm">
    <div class="card-body">

      <!-- ✅ κρατάμε mode για να μην αλλάζει -->
      <input type="hidden" name="mode" value="{{ mode }}">

      <!-- Dates / Times -->
      <div class="row g-3 mb-3">
        <div class="col-md-3">
          <label class="form-label">Ημ/νία Άφιξης</label>
          <input id="date_in_date" type="date" class="form-control form-control-sm"
                 name="date_in_date"
                 value="{{ (visit.date_in|string)[:10] if visit.date_in else '' }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">Ώρα Άφιξης</label>
          <input id="date_in_time" type="time" class="form-control form-control-sm"
                 name="date_in_time"
                 value="{{ (visit.date_in|string)[11:16] if visit.date_in else '' }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">Ημ/νία Παράδοσης</label>
          <input type="date" class="form-control form-control-sm"
                 name="date_out_date"
                 value="{{ (visit.date_out|string)[:10] if visit.date_out else '' }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">Ώρα Παράδοσης</label>
          <input type="time" class="form-control form-control-sm"
                 name="date_out_time"
                 value="{{ (visit.date_out|string)[11:16] if visit.date_out else '' }}">
        </div>
      </div>

      <!-- Vehicle -->
      <div class="row g-3 mb-3">
        <div class="col-md-3">
          <label class="form-label">Αρ. Εγγραφής</label>
          <input type="text" class="form-control form-control-sm"
                 name="plate_number" value="{{ visit.plate_number or '' }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">Αρ. Πλαισίου (VIN)</label>
          <input type="text" class="form-control form-control-sm"
                 name="vin" value="{{ visit.vin or '' }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">Μοντέλο</label>
          <input type="text" class="form-control form-control-sm"
                 name="model" value="{{ visit.model or '' }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">KM/H</label>
          <input type="text" class="form-control form-control-sm"
                 name="km" value="{{ visit.km or '' }}">
        </div>
      </div>

      <!-- Customer -->
      <div class="row g-3 mb-3">
        <div class="col-md-4">
          <label class="form-label">Όνομα</label>
          <input type="text" class="form-control form-control-sm"
                 name="customer_name" value="{{ visit.customer_name or '' }}">
        </div>
        <div class="col-md-4">
          <label class="form-label">Τηλέφωνο</label>
          <input type="text" class="form-control form-control-sm"
                 name="phone" value="{{ visit.phone or '' }}">
        </div>
        <div class="col-md-4">
          <label class="form-label">Email</label>
          <input type="text" class="form-control form-control-sm"
                 name="email" value="{{ visit.email or '' }}">
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label">Παράπονο / Σχόλια πελάτη</label>
        <textarea class="form-control form-control-sm"
                  name="customer_complaint" rows="2">{{ visit.customer_complaint or '' }}</textarea>
      </div>

      <hr>

      {% if lines|length == 0 %}
        <div class="alert alert-warning">
          Δεν υπάρχουν επιλεγμένες γραμμές ακόμη.
          Πάτα “Δείξε όλα” για να δεις όλη τη λίστα.
        </div>
      {% endif %}

      {% set current_cat = None %}
      {% for ln in lines %}
        {% if ln.category != current_cat %}
          {% set current_cat = ln.category %}
          <h6 class="mt-3 mb-2">{{ current_cat }}</h6>

          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th style="min-width:240px;">Έλεγχος</th>
                  <th style="width:140px;">Κατάσταση</th>
                  <th style="width:220px;">Parts Number</th>
                  <th style="width:110px;">Ποσότητα</th>
                  <th>Σημειώσεις</th>
                  <th style="width:150px;">Εκτύπωση</th>
                </tr>
              </thead>
              <tbody>
        {% endif %}

        <tr>
          <td><strong>{{ ln.item_name }}</strong></td>

          <td>
            <!-- ✅ θα το αλλάζει JS αυτόματα σε CHECK αν γράψεις parts/qty/notes -->
            <select name="result_{{ ln.id }}" class="form-select form-select-sm js-result" data-id="{{ ln.id }}">
              <option value="OK" {% if (ln.result or 'OK') == 'OK' %}selected{% endif %}>OK</option>
              <option value="CHECK" {% if (ln.result or '') == 'CHECK' %}selected{% endif %}>CHECK</option>
              <option value="REPAIR" {% if (ln.result or '') == 'REPAIR' %}selected{% endif %}>REPAIR</option>
            </select>
          </td>

          <td>
            <input type="text" class="form-control form-control-sm js-parts"
                   data-id="{{ ln.id }}"
                   name="parts_code_{{ ln.id }}" value="{{ ln.parts_code or '' }}">
          </td>

          <td>
            <input type="number" class="form-control form-control-sm js-qty"
                   data-id="{{ ln.id }}"
                   name="parts_qty_{{ ln.id }}" value="{{ ln.parts_qty or 0 }}">
          </td>

          <td>
            <input type="text" class="form-control form-control-sm js-notes"
                   data-id="{{ ln.id }}"
                   name="notes_{{ ln.id }}" value="{{ ln.notes or '' }}">
          </td>

          <td>
            <input type="hidden" name="exclude_{{ ln.id }}" value="0">
            <div class="form-check">
              <input class="form-check-input js-exclude" type="checkbox"
                     data-id="{{ ln.id }}"
                     name="exclude_{{ ln.id }}" value="1"
                     {% if ln.exclude_from_print %}checked{% endif %}>
              <label class="form-check-label" style="font-size:13px;">
                Μην τυπώνεται
              </label>
            </div>
          </td>
        </tr>

        {% set next_cat = lines[loop.index].category if not loop.last else None %}
        {% if next_cat != current_cat %}
              </tbody>
            </table>
          </div>
        {% endif %}
      {% endfor %}

      <div class="d-flex gap-2 mt-3 flex-wrap">
        <button class="btn btn-success" type="submit" name="after_save" value="stay">Save (Όλα)</button>
      </div>

      <hr>

      <!-- ✅ Add new line WITHOUT losing anything -->
      <h6 class="mb-2" id="addnew">+ Πρόσθεσε νέο πρόβλημα / έλεγχο</h6>
      <div class="row g-2">
        <div class="col-md-4">
          <input class="form-control form-control-sm" name="new_category"
                 placeholder="Κατηγορία" value="ΒΑΣΙΚΑ ΣΤΟΙΧΕΙΑ ΟΧΗΜΑΤΟΣ" required>
        </div>
        <div class="col-md-6">
          <input class="form-control form-control-sm" name="new_item_name"
                 placeholder="Περιγραφή (π.χ. Φρένα)" required>
        </div>
        <div class="col-md-1 d-flex align-items-center">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="new_add_to_master" value="1" id="newmaster">
            <label class="form-check-label" for="newmaster">Μνήμη</label>
          </div>
        </div>
        <div class="col-md-1">
          <button class="btn btn-success btn-sm w-100" type="submit" name="action" value="add_line">+</button>
        </div>
      </div>

      <div class="text-muted mt-2" style="font-size:13px;">
        ✔ Πατώντας “+” κάνει Save πρώτα και μετά προσθέτει. Η νέα γραμμή θα μπαίνει ως CHECK για να φαίνεται/εκτυπώνεται.
      </div>

    </div>
  </form>

</div>

<script>
  // ✅ Auto-fill arrival date/time from device if empty
  (function () {
    const d = document.getElementById("date_in_date");
    const t = document.getElementById("date_in_time");
    const now = new Date();
    const pad = (n) => String(n).padStart(2, "0");

    if (d && !d.value) d.value = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}`;
    if (t && !t.value) t.value = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
  })();

  // ✅ AUTO SELECT FOR PRINT:
  // Αν γράψεις Notes ή Parts No ή Qty, και το Result είναι OK, το κάνει CHECK αυτόματα.
  function autoSelectIfFilled(id) {
    const sel = document.querySelector(`.js-result[data-id="${id}"]`);
    const parts = document.querySelector(`.js-parts[data-id="${id}"]`);
    const qty = document.querySelector(`.js-qty[data-id="${id}"]`);
    const notes = document.querySelector(`.js-notes[data-id="${id}"]`);
    const ex = document.querySelector(`.js-exclude[data-id="${id}"]`);

    if (!sel || !parts || !qty || !notes) return;

    const filled = (parts.value.trim() !== "") || (parseInt(qty.value || "0") > 0) || (notes.value.trim() !== "");
    const excluded = ex && ex.checked;

    if (excluded) return;
    if (filled && sel.value === "OK") sel.value = "CHECK";
  }

  document.addEventListener("input", function(e){
    const id = e.target.getAttribute("data-id");
    if (!id) return;
    if (e.target.classList.contains("js-parts") || e.target.classList.contains("js-qty") || e.target.classList.contains("js-notes")) {
      autoSelectIfFilled(id);
    }
  });

  document.addEventListener("change", function(e){
    const id = e.target.getAttribute("data-id");
    if (!id) return;
    if (e.target.classList.contains("js-exclude")) {
      // αν το κάνεις exclude, δεν πειράζουμε status
      return;
    }
  });
</script>

{% endblock %}
