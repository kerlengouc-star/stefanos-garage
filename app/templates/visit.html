<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Επίσκεψη {{ visit.id }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    @media print {
      .no-print { display: none !important; }
      body { background: white !important; }
    }
  </style>
</head>

<body class="bg-light">
<div class="container py-3">

  <div class="d-flex justify-content-between align-items-center mb-3 no-print">
    <a class="btn btn-outline-secondary btn-sm" href="/">← Πίσω</a>

    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary btn-sm" href="/search">Αναζήτηση</a>
      <a class="btn btn-outline-secondary btn-sm" href="/checklist">Checklist (Μνήμη)</a>
      <a class="btn btn-outline-primary btn-sm" href="/visits/{{ visit.id }}/pdf" target="_blank" rel="noopener">PDF</a>
      <button type="button" class="btn btn-outline-dark btn-sm" onclick="window.print()">Print</button>
    </div>
  </div>

  <form method="post" action="/visits/{{ visit.id }}/save_all" class="card shadow-sm">
    <div class="card-body">

      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="m-0">JOB CARD: {{ visit.job_no or visit.id }}</h5>
        <button class="btn btn-primary btn-sm no-print" type="submit">Save (Όλα)</button>
      </div>

      <!-- Arrival / Delivery -->
      <div class="row g-2 mb-3">
        <div class="col-md-3">
          <label class="form-label">Ημ/νία Άφιξης</label>
          <input type="date" class="form-control form-control-sm" name="date_in_date" value="{{ (visit.date_in|string)[:10] if visit.date_in else '' }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">Ώρα Άφιξης</label>
          <input type="time" class="form-control form-control-sm" name="date_in_time" value="{{ (visit.date_in|string)[11:16] if visit.date_in else '' }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">Ημ/νία Παράδοσης</label>
          <input type="date" class="form-control form-control-sm" name="date_out_date" value="{{ (visit.date_out|string)[:10] if visit.date_out else '' }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">Ώρα Παράδοσης</label>
          <input type="time" class="form-control form-control-sm" name="date_out_time" value="{{ (visit.date_out|string)[11:16] if visit.date_out else '' }}">
        </div>
      </div>

      <!-- Vehicle / Customer -->
      <div class="row g-2 mb-3">
        <div class="col-md-3">
          <label class="form-label">Αρ. Εγγραφής</label>
          <input class="form-control form-control-sm" name="plate_number" value="{{ visit.plate_number or '' }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">Αρ. Πλαισίου</label>
          <input class="form-control form-control-sm" name="vin" value="{{ visit.vin or '' }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">Μοντέλο</label>
          <input class="form-control form-control-sm" name="model" value="{{ visit.model or '' }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">KM/H</label>
          <input class="form-control form-control-sm" name="km" value="{{ visit.km or '' }}">
        </div>
      </div>

      <div class="row g-2 mb-3">
        <div class="col-md-4">
          <label class="form-label">Όνομα</label>
          <input class="form-control form-control-sm" name="customer_name" value="{{ visit.customer_name or '' }}">
        </div>
        <div class="col-md-4">
          <label class="form-label">Τηλέφωνο</label>
          <input class="form-control form-control-sm" name="phone" value="{{ visit.phone or '' }}">
        </div>
        <div class="col-md-4">
          <label class="form-label">Email</label>
          <input class="form-control form-control-sm" name="email" value="{{ visit.email or '' }}">
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label">Παράπονο / Σχόλια πελάτη</label>
        <textarea class="form-control form-control-sm" name="customer_complaint" rows="2">{{ visit.customer_complaint or '' }}</textarea>
      </div>

      <hr>

      <!-- Checklist grouped by category -->
      {% set current_cat = None %}
      {% for ln in lines %}
        {% if ln.category != current_cat %}
          {% set current_cat = ln.category %}
          <h6 class="mt-3">{{ current_cat }}</h6>
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th style="min-width:220px">Έλεγχος</th>
                  <th style="width:140px">Κατάσταση</th>
                  <th style="width:180px">Parts Number</th>
                  <th style="width:120px">Ποσότητα</th>
                  <th>Σημειώσεις</th>
                </tr>
              </thead>
              <tbody>
        {% endif %}

        <tr>
          <td><strong>{{ ln.item_name }}</strong></td>
          <td>
            <select class="form-select form-select-sm" name="result_{{ ln.id }}">
              <option value="OK" {% if (ln.result or 'OK') == 'OK' %}selected{% endif %}>OK</option>
              <option value="CHECK" {% if (ln.result or '') == 'CHECK' %}selected{% endif %}>CHECK</option>
              <option value="REPAIR" {% if (ln.result or '') == 'REPAIR' %}selected{% endif %}>REPAIR</option>
            </select>
          </td>
          <td><input class="form-control form-control-sm" name="parts_code_{{ ln.id }}" value="{{ ln.parts_code or '' }}"></td>
          <td><input class="form-control form-control-sm" name="parts_qty_{{ ln.id }}" value="{{ ln.parts_qty or 0 }}"></td>
          <td><input class="form-control form-control-sm" name="notes_{{ ln.id }}" value="{{ ln.notes or '' }}"></td>
        </tr>

        {% set next_cat = lines[loop.index].category if not loop.last else None %}
        {% if next_cat != current_cat %}
              </tbody>
            </table>
          </div>
        {% endif %}
      {% endfor %}

      <div class="d-flex gap-2 mt-3 no-print">
        <button class="btn btn-primary btn-sm" type="submit">Save (Όλα)</button>
        <a class="btn btn-outline-primary btn-sm" href="/visits/{{ visit.id }}/pdf" target="_blank" rel="noopener">PDF</a>
        <button type="button" class="btn btn-outline-dark btn-sm" onclick="window.print()">Print</button>
      </div>

    </div>
  </form>

</div>
</body>
</html>
