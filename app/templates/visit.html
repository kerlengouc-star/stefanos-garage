{% extends "base.html" %}
{% block content %}

<div class="container py-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4>JOB CARD: {{ visit.job_no }}</h4>

    <div class="d-flex gap-2">

      <a class="btn btn-outline-dark btn-sm"
         href="/visits/{{ visit.id }}/print"
         target="_blank">Print</a>

      <a class="btn btn-outline-primary btn-sm"
         href="/visits/{{ visit.id }}/pdf"
         target="_blank">PDF</a>

      <a class="btn btn-outline-secondary btn-sm"
         href="/history">Ιστορικό</a>

      <a class="btn btn-outline-danger btn-sm"
         href="/">Πίσω</a>

    </div>
  </div>


  <form method="post" action="/visits/{{ visit.id }}/save_all">

    <div class="card mb-3">
      <div class="card-body">

        <div class="row g-3">

          <div class="col-md-3">
            <label class="form-label">Αρ. Εγγραφής</label>
            <input type="text" class="form-control"
                   name="plate_number"
                   value="{{ visit.plate_number or '' }}">
          </div>

          <div class="col-md-3">
            <label class="form-label">VIN</label>
            <input type="text" class="form-control"
                   name="vin"
                   value="{{ visit.vin or '' }}">
          </div>

          <div class="col-md-3">
            <label class="form-label">Μοντέλο</label>
            <input type="text" class="form-control"
                   name="model"
                   value="{{ visit.model or '' }}">
          </div>

          <div class="col-md-3">
            <label class="form-label">KM</label>
            <input type="text" class="form-control"
                   name="km"
                   value="{{ visit.km or '' }}">
          </div>

          <div class="col-md-4">
            <label class="form-label">Πελάτης</label>
            <input type="text" class="form-control"
                   name="customer_name"
                   value="{{ visit.customer_name or '' }}">
          </div>

          <div class="col-md-4">
            <label class="form-label">Τηλέφωνο</label>
            <input type="text" class="form-control"
                   name="phone"
                   value="{{ visit.phone or '' }}">
          </div>

          <div class="col-md-4">
            <label class="form-label">Email</label>
            <input type="text" class="form-control"
                   name="email"
                   value="{{ visit.email or '' }}">
          </div>

        </div>

      </div>
    </div>


    {% set current_category = None %}

    {% for ln in lines %}

      {% if ln.category != current_category %}
        {% set current_category = ln.category %}
        <h5 class="mt-4">{{ current_category }}</h5>
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>Έλεγχος</th>
                <th style="width:120px;">Κατάσταση</th>
                <th style="width:200px;">Parts Code</th>
                <th style="width:90px;">Qty</th>
                <th style="width:160px;">Σημειώσεις</th>
                <th style="width:140px;">Εξαίρεση</th>
              </tr>
            </thead>
            <tbody>
      {% endif %}

      <tr>
        <td>{{ ln.item_name }}</td>

        <td>
          <select name="result_{{ ln.id }}" class="form-select form-select-sm">
            <option value="OK" {% if ln.result=="OK" %}selected{% endif %}>OK</option>
            <option value="CHECK" {% if ln.result=="CHECK" %}selected{% endif %}>CHECK</option>
            <option value="REPAIR" {% if ln.result=="REPAIR" %}selected{% endif %}>REPAIR</option>
          </select>
        </td>

        <td>
          <input type="text"
                 name="parts_code_{{ ln.id }}"
                 value="{{ ln.parts_code or '' }}"
                 class="form-control form-control-sm">
        </td>

        <td>
          <input type="number"
                 name="parts_qty_{{ ln.id }}"
                 value="{{ ln.parts_qty or 0 }}"
                 class="form-control form-control-sm">
        </td>

        <td>
          <input type="text"
                 name="notes_{{ ln.id }}"
                 value="{{ ln.notes or '' }}"
                 class="form-control form-control-sm">
        </td>

        <td>
          <input type="hidden" name="exclude_{{ ln.id }}" value="0">
          <input type="checkbox"
                 name="exclude_{{ ln.id }}"
                 value="1"
                 {% if ln.exclude_from_print %}checked{% endif %}>
          Μην τυπώνεται
        </td>

      </tr>

      {% if loop.last or lines[loop.index].category != current_category %}
            </tbody>
          </table>
        </div>
      {% endif %}

    {% endfor %}

    <div class="mt-4">
      <button class="btn btn-success">Αποθήκευση</button>
    </div>

  </form>

</div>

{% endblock %}
