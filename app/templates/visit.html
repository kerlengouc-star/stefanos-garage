{% extends "base.html" %}
{% block content %}

<h2>JOB CARD: {{ visit.job_no or visit.id }}</h2>

<div style="display:flex; gap:10px; flex-wrap:wrap; margin: 10px 0;">
  <a href="/backup" class="btn">Backup</a>
  <a href="/visits/{{ visit.id }}/pdf" class="btn" target="_blank">PDF</a>
  <a href="/visits/{{ visit.id }}/print" class="btn" target="_blank">Print</a>
  <a href="/history" class="btn">Ιστορικό</a>
  <a href="/" class="btn">Πίσω</a>
</div>

<div style="margin: 8px 0;">
  Προβολή:
  {% if mode == "all" %}
    <b>Όλα</b> | <a href="/visits/{{ visit.id }}?mode=selected">Μόνο επιλεγμένα</a>
  {% else %}
    <b>Μόνο επιλεγμένα</b> | <a href="/visits/{{ visit.id }}?mode=all">Δείξε όλα</a>
  {% endif %}
</div>

<form method="post" action="/visits/{{ visit.id }}/save_all">
  <input type="hidden" name="mode" value="{{ mode }}" />
  <input type="hidden" name="action" value="" id="actionField" />
  <input type="hidden" name="after_save" value="stay" id="afterSaveField" />

  <fieldset style="border:1px solid #ddd; padding:10px; margin-top:10px;">
    <legend><b>ΣΤΟΙΧΕΙΑ ΠΕΛΑΤΗ / ΟΧΗΜΑΤΟΣ</b></legend>

    <div style="display:grid; grid-template-columns: repeat(2, minmax(220px, 1fr)); gap:10px;">
      <div>
        <label>Ημ/νία Άφιξης</label>
        <input type="date" name="date_in_date" value="{{ visit.date_in.strftime('%Y-%m-%d') if visit.date_in else '' }}">
      </div>
      <div>
        <label>Ώρα Άφιξης</label>
        <input type="time" name="date_in_time" value="{{ visit.date_in.strftime('%H:%M') if visit.date_in else '' }}">
      </div>

      <div>
        <label>Ημ/νία Παράδοσης</label>
        <input type="date" name="date_out_date" value="{{ visit.date_out.strftime('%Y-%m-%d') if visit.date_out else '' }}">
      </div>
      <div>
        <label>Ώρα Παράδοσης</label>
        <input type="time" name="date_out_time" value="{{ visit.date_out.strftime('%H:%M') if visit.date_out else '' }}">
      </div>

      <div>
        <label>Αρ. Εγγραφής</label>
        <input type="text" name="plate_number" value="{{ visit.plate_number or '' }}">
      </div>
      <div>
        <label>Αρ. Πλαισίου (VIN)</label>
        <input type="text" name="vin" value="{{ visit.vin or '' }}">
      </div>

      <div>
        <label>Μοντέλο</label>
        <input type="text" name="model" value="{{ visit.model or '' }}">
      </div>
      <div>
        <label>KM/H</label>
        <input type="text" name="km" value="{{ visit.km or '' }}">
      </div>

      <div>
        <label>Όνομα</label>
        <input type="text" name="customer_name" value="{{ visit.customer_name or '' }}">
      </div>
      <div>
        <label>Τηλέφωνο</label>
        <input type="text" name="phone" value="{{ visit.phone or '' }}">
      </div>

      <div>
        <label>Email</label>
        <input type="email" name="email" value="{{ visit.email or '' }}">
      </div>
      <div></div>
    </div>

    <div style="margin-top:10px;">
      <label>Παράπονο / Σχόλια πελάτη</label>
      <textarea name="customer_complaint" rows="3" style="width:100%;">{{ visit.customer_complaint or '' }}</textarea>
    </div>
  </fieldset>

  <hr>

  {% if lines|length == 0 %}
    <p><b>Δεν υπάρχουν γραμμές.</b> Δοκίμασε “Δείξε όλα”.</p>
  {% endif %}

  {% set current_cat = None %}
  {% for ln in lines %}
    {% if ln.category != current_cat %}
      {% set current_cat = ln.category %}
      <h3 style="margin-top:18px;">{{ current_cat }}</h3>

      <table style="width:100%; border-collapse:collapse;">
        <thead>
          <tr>
            <th style="text-align:left; border-bottom:1px solid #ccc; padding:6px;">Έλεγχος</th>
            <th style="border-bottom:1px solid #ccc; padding:6px;">Κατάσταση</th>
            <th style="border-bottom:1px solid #ccc; padding:6px;">Parts Number</th>
            <th style="border-bottom:1px solid #ccc; padding:6px;">Ποσότητα</th>
            <th style="text-align:left; border-bottom:1px solid #ccc; padding:6px;">Σημειώσεις</th>
            <th style="border-bottom:1px solid #ccc; padding:6px;">Μην τυπώνεται</th>
          </tr>
        </thead>
        <tbody>
    {% endif %}

      <tr>
        <td style="padding:6px; border-bottom:1px solid #eee;">{{ ln.item_name }}</td>
        <td style="padding:6px; border-bottom:1px solid #eee; text-align:center;">
          <select name="result_{{ ln.id }}">
            <option value="OK" {% if (ln.result or 'OK') == 'OK' %}selected{% endif %}>OK</option>
            <option value="CHECK" {% if (ln.result or '') == 'CHECK' %}selected{% endif %}>CHECK</option>
            <option value="REPAIR" {% if (ln.result or '') == 'REPAIR' %}selected{% endif %}>REPAIR</option>
          </select>
        </td>
        <td style="padding:6px; border-bottom:1px solid #eee; text-align:center;">
          <input type="text" name="parts_code_{{ ln.id }}" value="{{ ln.parts_code or '' }}" style="width:140px;">
        </td>
        <td style="padding:6px; border-bottom:1px solid #eee; text-align:center;">
          <input type="number" min="0" name="parts_qty_{{ ln.id }}" value="{{ ln.parts_qty or 0 }}" style="width:80px;">
        </td>
        <td style="padding:6px; border-bottom:1px solid #eee;">
          <input type="text" name="notes_{{ ln.id }}" value="{{ ln.notes or '' }}" style="width:100%;">
        </td>
        <td style="padding:6px; border-bottom:1px solid #eee; text-align:center;">
          <input type="checkbox" name="exclude_{{ ln.id }}" value="1" {% if ln.exclude_from_print %}checked{% endif %}>
        </td>
      </tr>

    {% set next_cat = lines[loop.index].category if not loop.last else None %}
    {% if next_cat != current_cat %}
        </tbody>
      </table>
    {% endif %}
  {% endfor %}

  <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:16px;">
    <button type="submit" class="btn" onclick="document.getElementById('afterSaveField').value='stay'; document.getElementById('actionField').value='';">
      Save (Όλα)
    </button>

    <button type="submit" class="btn" onclick="document.getElementById('afterSaveField').value='pdf'; document.getElementById('actionField').value='';">
      Save + PDF
    </button>

    <button type="submit" class="btn" onclick="document.getElementById('afterSaveField').value='print'; document.getElementById('actionField').value='';">
      Save + Print
    </button>
  </div>

  <hr>

  <h3 id="addnew">+ Πρόσθεσε νέο πρόβλημα / έλεγχο</h3>

  <div style="display:grid; grid-template-columns: repeat(2, minmax(220px, 1fr)); gap:10px;">
    <div>
      <label>Κατηγορία</label>
      <input type="text" name="new_category" placeholder="π.χ. ΗΛΕΚΤΡΟΛΟΓΙΚΑ">
    </div>
    <div>
      <label>Πρόβλημα / Έλεγχος</label>
      <input type="text" name="new_item_name" placeholder="π.χ. Έλεγχος δυναμό">
    </div>
  </div>

  <div style="margin-top:10px;">
    <label>
      <input type="checkbox" name="new_add_to_master" value="1">
      Μνήμη (να μπει και στο Checklist για πάντα)
    </label>
  </div>

  <div style="margin-top:10px;">
    <button type="submit" class="btn"
      onclick="document.getElementById('actionField').value='add_line'; document.getElementById('afterSaveField').value='stay';">
      +
    </button>

    <span style="margin-left:10px;">
      ✔ Πατώντας “+” κάνει Save πρώτα και μετά προσθέτει. Η νέα γραμμή μπαίνει ως CHECK ώστε να φαίνεται/εκτυπώνεται.
    </span>
  </div>

  <hr>

  <h3>Email PDF (προαιρετικό)</h3>
  <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
    <input type="email" name="to_email" placeholder="example@email.com" form="emailForm" style="min-width:240px;">
  </div>

</form>

<form id="emailForm" method="post" action="/visits/{{ visit.id }}/email" style="margin-top:8px;">
  <input type="email" name="to_email" placeholder="example@email.com" style="min-width:240px;">
  <button type="submit" class="btn">Send Email</button>
</form>

<script>
  // αν είναι νέο visit και δεν έχει ώρα/ημερομηνία, να βάλει την ώρα του υπολογιστή
  (function(){
    const inDate = document.querySelector('input[name="date_in_date"]');
    const inTime = document.querySelector('input[name="date_in_time"]');
    if (inDate && inTime && !inDate.value) {
      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth()+1).padStart(2,'0');
      const dd = String(now.getDate()).padStart(2,'0');
      const hh = String(now.getHours()).padStart(2,'0');
      const mi = String(now.getMinutes()).padStart(2,'0');
      inDate.value = `${yyyy}-${mm}-${dd}`;
      inTime.value = `${hh}:${mi}`;
    }
  })();
</script>

{% endblock %}
