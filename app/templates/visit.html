{% extends "base.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <div class="d-flex gap-2 align-items-center">
    <a class="btn btn-outline-secondary btn-sm" href="/">← Πίσω</a>
    <div class="fw-semibold">Επίσκεψη #{{ visit.id }}</div>
    <span class="badge text-bg-light">{{ "Επιλεγμένες" if mode=="selected" else "Όλες" }}</span>
  </div>

  <div class="d-flex gap-2">
    <a class="btn btn-outline-primary btn-sm" href="/visits/{{ visit.id }}?mode=all">Όλες</a>
    <a class="btn btn-outline-primary btn-sm" href="/visits/{{ visit.id }}?mode=selected">Επιλεγμένες</a>
    <a class="btn btn-outline-primary btn-sm" href="/visits/{{ visit.id }}/pdf" target="_blank">PDF</a>
    <a class="btn btn-outline-primary btn-sm" href="/visits/{{ visit.id }}/print" target="_blank">Print</a>
  </div>
</div>

<form method="post" action="/visits/{{ visit.id }}/save_all" id="visit-form">
  <!-- ✅ κρατάμε το mode ώστε μετά το save να μείνει ίδιο -->
  <input type="hidden" name="mode" value="{{ mode }}">

  <!-- Customer / vehicle card (πάνω) -->
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <div class="row g-2">
        <div class="col-md-3">
          <label class="form-label">Όνομα Πελάτη</label>
          <input class="form-control" name="customer_name" value="{{ visit.customer_name or '' }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">Τηλέφωνο</label>
          <input class="form-control" name="phone" value="{{ visit.phone or '' }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">Email</label>
          <input class="form-control" name="email" value="{{ visit.email or '' }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">Πινακίδα</label>
          <input class="form-control" name="plate_number" value="{{ visit.plate_number or '' }}">
        </div>

        <div class="col-md-3">
          <label class="form-label">Μοντέλο</label>
          <input class="form-control" name="model" value="{{ visit.model or '' }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">VIN</label>
          <input class="form-control" name="vin" value="{{ visit.vin or '' }}">
        </div>
        <div class="col-md-2">
          <label class="form-label">KM</label>
          <input class="form-control" name="km" value="{{ visit.km or '' }}">
        </div>

        <div class="col-md-2">
          <label class="form-label">Άφιξη (Ημ/νία)</label>
          <input class="form-control" type="date" name="date_in" value="{{ visit.date_in.strftime('%Y-%m-%d') if visit.date_in else '' }}">
        </div>
        <div class="col-md-2">
          <label class="form-label">Άφιξη (Ώρα)</label>
          <input class="form-control" type="time" name="time_in" value="{{ visit.date_in.strftime('%H:%M') if visit.date_in else '' }}">
        </div>

        <div class="col-md-2">
          <label class="form-label">Παράδοση (Ημ/νία)</label>
          <input class="form-control" type="date" name="date_out" value="{{ visit.date_out.strftime('%Y-%m-%d') if visit.date_out else '' }}">
        </div>
        <div class="col-md-2">
          <label class="form-label">Παράδοση (Ώρα)</label>
          <input class="form-control" type="time" name="time_out" value="{{ visit.date_out.strftime('%H:%M') if visit.date_out else '' }}">
        </div>

        <div class="col-12">
          <label class="form-label">Παράπονο / Τι θέλει ο πελάτης</label>
          <textarea class="form-control" name="customer_complaint" rows="2">{{ visit.customer_complaint or '' }}</textarea>
        </div>
      </div>
    </div>
  </div>

  <!-- Controls -->
  <div class="d-flex flex-wrap gap-2 align-items-center mb-2">
    <button type="button" class="btn btn-outline-secondary btn-sm" id="open-all">Άνοιγμα όλων</button>
    <button type="button" class="btn btn-outline-secondary btn-sm" id="close-all">Κλείσιμο όλων</button>
    <span class="small text-muted ms-1">Tip: Μπορείς να έχεις πολλές κατηγορίες ανοιχτές μαζί.</span>
  </div>

  <!-- ✅ Multi-open collapsibles (NO data-bs-parent) -->
  <div class="accordion" id="cats-accordion">
    {% set current_cat = None %}
    {% set cat_index = 0 %}

    {% for ln in lines %}
      {% if current_cat != ln.category %}
        {% if current_cat is not none %}
              </div>
            </div>
          </div>
        {% endif %}

        {% set current_cat = ln.category %}
        {% set cat_index = cat_index + 1 %}
        {% set cid = "cat_" ~ cat_index %}

        <div class="accordion-item mb-2">
          <h2 class="accordion-header" id="{{ cid }}_head">
            <button class="accordion-button collapsed" type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#{{ cid }}_body"
                    aria-expanded="false"
                    aria-controls="{{ cid }}_body">
              {{ current_cat }}
            </button>
          </h2>

          <div id="{{ cid }}_body" class="accordion-collapse collapse" aria-labelledby="{{ cid }}_head">
            <div class="accordion-body p-2">
              <div class="table-responsive">
                <table class="table table-sm align-middle mb-0">
                  <thead>
                    <tr class="small text-muted">
                      <th style="width:34%">Εργασία</th>
                      <th style="width:16%">Κατάσταση</th>
                      <th style="width:26%">Σημειώσεις</th>
                      <th style="width:14%">Part Code</th>
                      <th style="width:10%">Qty</th>
                      <th style="width:8%" class="text-center">Print</th>
                    </tr>
                  </thead>
                  <tbody>
      {% endif %}

        <tr>
          <td class="fw-semibold">{{ ln.item_name }}</td>

          <td>
            <select class="form-select form-select-sm" name="result_{{ ln.id }}">
              <option value="OK" {% if (ln.result or 'OK') == 'OK' %}selected{% endif %}>OK</option>
              <option value="CHECK" {% if (ln.result or '') == 'CHECK' %}selected{% endif %}>CHECK</option>
              <option value="REPAIR" {% if (ln.result or '') == 'REPAIR' %}selected{% endif %}>REPAIR</option>
            </select>
          </td>

          <td>
            <input class="form-control form-control-sm" name="notes_{{ ln.id }}" value="{{ ln.notes or '' }}">
          </td>

          <td>
            <input class="form-control form-control-sm mono" name="parts_code_{{ ln.id }}" value="{{ ln.parts_code or '' }}">
          </td>

          <td>
            <input class="form-control form-control-sm" type="number" min="0" name="parts_qty_{{ ln.id }}" value="{{ ln.parts_qty or 0 }}">
          </td>

          <td class="text-center">
            <input class="form-check-input" type="checkbox" name="exclude_{{ ln.id }}" {% if ln.exclude_from_print %}checked{% endif %}>
          </td>
        </tr>

    {% endfor %}

    {% if current_cat is not none %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
    {% endif %}
  </div>

  <!-- ✅ Save at end -->
  <div class="d-flex justify-content-end gap-2 mt-3">
    <button class="btn btn-primary" type="submit">Αποθήκευση</button>
  </div>
</form>

<script>
  // Open/close all category collapses
  function getAllCollapses() {
    return Array.from(document.querySelectorAll('.accordion-collapse'));
  }

  document.getElementById('open-all').addEventListener('click', () => {
    getAllCollapses().forEach(el => bootstrap.Collapse.getOrCreateInstance(el, {toggle:false}).show());
  });

  document.getElementById('close-all').addEventListener('click', () => {
    getAllCollapses().forEach(el => bootstrap.Collapse.getOrCreateInstance(el, {toggle:false}).hide());
  });

  // Optional: when mode=selected, open all by default (so you immediately see them)
  {% if mode == "selected" %}
  window.addEventListener('load', () => {
    getAllCollapses().forEach(el => bootstrap.Collapse.getOrCreateInstance(el, {toggle:false}).show());
  });
  {% endif %}
</script>

<!-- Bootstrap JS (if not already globally included) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

{% endblock %}
